<template>
  <div class="fixed top-2 right-2 z-40 flex items-start pt-3 w-1/3">
    <SwitchGroup class="pt-2 ml-auto">
      <div class="flex items-center">
        <SwitchLabel class="mr-4">
          Validierung:
        </SwitchLabel>
        <HeadlessSwitch
          :model-value="validationEnabled"
          :class="validationEnabled ? 'bg-teal-700' : 'bg-gray-500'"
          class="relative inline-flex h-6 w-11 items-center rounded-full"
          @update:model-value="setValidationEnabled"
        >
          <span
            aria-hidden="true"
            :class="validationEnabled ? 'translate-x-6' : 'translate-x-1'"
            class="inline-block h-4 w-4 transform rounded-full bg-white transition"
          />
        </HeadlessSwitch>
      </div>
    </SwitchGroup>
    <GlobalValidationInfo />
  </div>
  <div class="fixed top-2 right-2 z-50">
    <ToastNotification
      v-for="message in errorMessages"
      :key="message"
      :duration="4500"
      :show-toast="true"
      :text="message"
    />
    <ToastNotification
      :text="'Folgende Module konnten nicht wiederhergestellt werden'"
      :show-toast="unknownModules?.length != 0"
      :list-items="unknownModules.map(u => `- ${u.id} in semester ${u.semesterNumber}`)"
      :dismiss-button-text="'OK'"
      @on-dismiss="removeUnknownModulesFromUrl"
    />
  </div>
  <div class="flex space-x-2 overflow-auto before:m-auto after:m-auto p-4">
    <SemesterComponent
      v-for="semester in enrichedSemesters"
      :key="semester.number"
      class="bg-gray-200 rounded p-2 group/semester w-64 min-w-64"
      :semester="semester"
      :all-modules="modules"
      @on-module-deleted="(moduleId: string) => removeModule(semester.number, moduleId)"
      @on-add-module="addModule"
      @on-remove-semester="removeSemester"
      @on-drop-end="updateUrlFragment"
    />
    <button
      class="transition-colors text-white w-8 px-2 rounded"
      :class="addingSemesterIsDisabled? 'bg-gray-300' : 'bg-gray-500 hover:bg-gray-800'"
      type="button"
      :disabled="addingSemesterIsDisabled"
      :title="addingSemesterIsDisabled ?
        'Mehr als 14 Semester können an der OST nicht geplant werden, da sonst eine Exmatrikulation stattfindet' :
        ''
      "
      @click="addSemester"
    >
      +
    </button>
  </div>
  <div class="my-16 grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 justify-items-center gap-y-16">
    <article class="mx-4">
      <span class="text-xl">
        Übersicht der ECTS Punkte
      </span>
      <div class="my-2 flex items-center">
        <label for="last-semester-select">
          Erstes Semester:
        </label>
        <select
          id="last-semester-select"
          :value="startSemester"
          class="ml-2 px-3 py-2 rounded"
          @change="setStartSemester($event.target.value)"
        >
          <option
            v-for="semester in selectableStartSemesters"
            :key="semester.toString()"
            :value="semester"
          >
            {{ semester.toString() }}
          </option>
        </select>
        <a
          class="ml-3 underline"
          target="_blank"
          :href="studienOrdnungToUrlMap[studienordnung]"
        >Studienordnung</a>
      </div>
      <Categories
        @on-add-module="addModule"
      />
    </article>
    <article class="mx-4">
      <h2 class="text-xl">
        Vertiefungen
      </h2>
      <div class="mt-5">
        <div
          v-for="focus in enrichedFocuses"
          :key="focus.name"
        >
          <FocusComponent
            :name="focus.name"
            :available-modules-for-focus="focus.availableModules"
            :number-of-missing-modules="focus.numberOfMissingModules"
            @on-add-module-to-next-sem="addModule"
          />
        </div>
      </div>
    </article>
    <img
      class="lg:col-span-2 2xl:col-span-1 justify-self-center px-4"
      src="../assets/this_is_fine.jpg"
      alt="The well known 'this is fine' meme with a dog in a room full of fire"
    >
  </div>
</template>

<script lang="ts">
import { defineComponent } from 'vue';
import SemesterComponent from '../components/Semester.vue';
import FocusComponent from '../components/Focus.vue';
import ToastNotification from '../components/ToastNotification.vue';
import { Module, UnknownModule} from '../helpers/types';
import { SemesterInfo } from "../helpers/semester-info";
import Categories from '../components/Categories.vue';
import { StorageHelper } from '../helpers/storage-helper';
import { Switch as HeadlessSwitch, SwitchGroup, SwitchLabel } from '@headlessui/vue'
import { store } from '../helpers/store';
import { mapGetters } from 'vuex';
import GlobalValidationInfo from '../components/GlobalValidationInfo.vue';

export default defineComponent({
  name: 'Home',
  components: {
    SemesterComponent,
    FocusComponent,
    ToastNotification,
    Categories,
    HeadlessSwitch,
    SwitchGroup,
    SwitchLabel,
    GlobalValidationInfo
  },
  data() {
    return {
      selectableStartSemesters: SemesterInfo.selectableStartSemesters,
      studienOrdnungToUrlMap: {
        '21': 'https://studien.ost.ch/allStudies/10191_I.html',
        '23': 'https://studien.ost.ch/allStudies/10246_I.html'
      },
      errorMessages: [] as string[],
      unknownModules: [] as UnknownModule[],
    };
  },
  computed: {
    ...mapGetters([
      'modules',
      'enrichedFocuses',
      'enrichedSemesters',
      'startSemester',
      'studienordnung',
      'validationEnabled'
    ]),
    addingSemesterIsDisabled() {
      return this.enrichedSemesters.length >= SemesterInfo.maxNumberOfAllowedSemesters;
    },
  },
  watch: {
    $route: {
      handler() {
        setTimeout(() => {
          this.getPlanDataFromUrl();
        }, 0);
      },
    },
  },
  async mounted() {
    await store.dispatch('loadModules');
    this.getPlanDataFromUrl();
  },
  methods: {
    setStartSemester(startSemester: string) {
      const newStartSemester = SemesterInfo.parse(startSemester);
      store.dispatch('setStartSemester', newStartSemester).then(() => this.updateUrlFragment());
    },
    setValidationEnabled(validationEnabled: boolean) {
      store.commit('setValidationEnabled', validationEnabled);
      this.updateUrlFragment();
    },
    sumCredits: (previousTotal: number, module: Module) => previousTotal + module.ects,
    getPlanDataFromUrl() {
      const [
        semesters,
        startSemester,
        validationEnabled
      ] = StorageHelper.getDataFromUrlHash(
        window.location.hash,
        (semesterNumber: number, moduleId: string) => this.showUnknownModulesError(semesterNumber, moduleId)
      );
      store.commit('setValidationEnabled', validationEnabled);
      store.commit('setSemesters', semesters);
      store.dispatch('setStartSemester', startSemester).then(() => this.updateUrlFragment());
    },
    updateUrlFragment() {
      StorageHelper.updateUrlFragment(this.enrichedSemesters, this.startSemester, this.validationEnabled);
    },
    getPlannedSemesterForModule(moduleName: string): number | undefined {
      return this.enrichedSemesters.find(
        (semester) => semester.modules.some((module) => module.name === moduleName),
      )?.number;
    },
    addModule(moduleName: string, semesterNumber?: number) {
      const blockingSemesterNumber = this.getPlannedSemesterForModule(moduleName);
      if (blockingSemesterNumber) {
        const text = `Modul ${moduleName} ist bereits im Semester ${blockingSemesterNumber}`;
        console.warn(text);
        this.showErrorMsg(text);
        return;
      }

      const module = this.modules.find((item) => item.name === moduleName);

      if (module === undefined) {
        this.showErrorMsg(`Modul '${moduleName}' existiert nicht`);
        return;
      }

      if(!semesterNumber) {
        if(!module.nextPossibleSemester) {
          this.showErrorMsg(`Kein nächstmögliches Semester für Modul ${moduleName} gefunden`);
          return;
        }
        let nextSemester = this.enrichedSemesters.find(s => s.name === module.nextPossibleSemester.toString())
        while(!nextSemester && !this.addingSemesterIsDisabled) {
          this.addSemester();
          nextSemester = this.enrichedSemesters.find(s => s.name === module.nextPossibleSemester.toString());
        }
        semesterNumber = nextSemester.number;
      }

      store.commit('addModuleToSemester', {semesterNumber, moduleId: module.id});
      this.updateUrlFragment();
    },
    removeModule(semesterNumber: number, moduleId: string) {
      store.commit('removeModuleFromSemester', { semesterNumber, moduleId });
      this.unknownModules = this.unknownModules.filter((f) => f.id !== moduleId);
      this.updateUrlFragment();
    },
    addSemester() {
      if(this.addingSemesterIsDisabled) {
        this.showErrorMsg(
          `Es können nicht mehr als ${SemesterInfo.maxNumberOfAllowedSemesters} Semester geplant werden!`
        );
        return;
      }
      store.commit('addSemester')
      this.updateUrlFragment();
    },
    removeSemester(semesterNumber: number) {
      store.commit('removeSemester', semesterNumber);
      this.unknownModules = this.unknownModules.filter((f) => f.semesterNumber !== semesterNumber);
      this.updateUrlFragment();
    },
    showErrorMsg(text: string) {
      this.errorMessages.push(text);
      setTimeout(() => {
        this.errorMessages.shift();
        // clean up error messages after a minute
      }, 60000);
    },
    showUnknownModulesError(semesterNumber: number, moduleId: string) {
      if (this.unknownModules.find((f) => f.id === moduleId)) return;
      this.unknownModules.push({ semesterNumber, id: moduleId });
    },
    removeUnknownModulesFromUrl() {
      this.unknownModules = [];
      this.updateUrlFragment();
    },
  },
});
</script>
